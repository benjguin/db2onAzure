{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "pubKeyValue": {
            "type": "string"
        },
        "adwinPassword": {
            "type": "securestring"
        },
        "db2bits": {
            "type": "string"
        },
        "gitrawurl": {
            "type": "string"
        },
        "vnetName": {
            "defaultValue": "db2vnet",
            "type": "string"
        },
        "nbDb2MemberVms": {
            "defaultValue": 2,
            "type": "int"
        },
        "nbDb2CfVms": {
            "defaultValue": 2,
            "type": "int"
        },
        "nbGlusterFsVms": {
            "defaultValue": 3,
            "type": "int"
        },
        "jumpboxPublicName": {
            "defaultValue": "[concat('jbox',uniqueString(resourceGroup().id, 'jumpbox'))]",
            "type": "string"
        }
    },
    "variables": {
        "location": "[resourceGroup().location]",
        "uniqueString1": "[uniqueString(resourceGroup().id, '1')]",
        "linkedTemplatesUrl": "[concat(parameters('gitrawurl'),'deployment/linkedtemplates/')]",
        "db2MemberSubnets": ["main", "gpfsfe", "db2be", "db2fe"],
        "db2MemberIpAdddressPrefixes": ["192.168.0.2", "192.168.1.2", "192.168.3.2", "192.168.4.2"],
        "db2CfSubnets": ["main", "gpfsfe", "db2be"],
        "db2CfIpAdddressPrefixes": ["192.168.0.4", "192.168.1.4", "192.168.3.4"],
        "glusterFsSubnets": ["main", "gpfsfe", "gpfsbe"],
        "glusterFsIpAdddressPrefixes": ["192.168.0.1", "192.168.1.1", "192.168.2.1"],
        "witnessSubnets": ["main", "gpfsfe", "db2be", "db2fe"],
        "witnessIpAdddressPrefixes": ["192.168.0.6", "192.168.1.6", "192.168.3.6", "192.168.4.6"],
        "jumpboxSubnets": ["main"],
        "jumpboxIpAdddressPrefixes": ["192.168.0.5"]
    },
    "resources": [
        {
            "comments": "jumpbox public IP address",
            "type": "Microsoft.Network/publicIPAddresses",
            "sku": {
                "name": "Basic",
                "tier": "Regional"
            },
            "name": "jumbox_public_ip",
            "apiVersion": "2018-02-01",
            "location": "[variables('location')]",
            "scale": null,
            "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Dynamic",
                "idleTimeoutInMinutes": 4,
                "dnsSettings": {
                    "domainNameLabel": "[parameters('jumpboxPublicName')]"
                },
                "ipTags": []
            },
            "dependsOn": []
        },
        {
            "comments": "vNET and NSG",
            "type": "Microsoft.Resources/deployments",
            "name": "vNetAndNsg",
            "apiVersion": "2015-01-01",
            "properties": {
                    "mode": "Incremental",
                    "templateLink": {
                    "uri": "[concat(variables('linkedTemplatesUrl'), 'vnet_template.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    }
                }
            },
            "dependsOn": []            
        },
        {
            "comments": "db2 member NICs",
            "type": "Microsoft.Resources/deployments",
            "name": "db2_member_nics",
            "apiVersion": "2015-01-01",
            "properties": {
                    "mode": "Incremental",
                    "templateLink": {
                    "uri": "[concat(variables('linkedTemplatesUrl'), 'nics_template.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    },
                    "subnetName": {
                        "value": "[variables('db2MemberSubnets')[copyIndex()]]"
                    },
                    "ipAdddressPrefix": {
                        "value": "[variables('db2MemberIpAdddressPrefixes')[copyIndex()]]"
                    },
                    "vmPrefix": {
                        "value": "d"
                    },
                    "nb_vms": {
                        "value": "[parameters('nbDb2MemberVms')]"
                    }
                }
            },
            "copy": {
                "name": "db2_member_nics_copy",
                "count": "[length(variables('db2MemberSubnets'))]"
            },
            "dependsOn": ["vNetAndNsg"]            
        },
        {
            "comments": "db2 members VMs",
            "type": "Microsoft.Compute/virtualMachines",
            "name": "[concat('d', copyIndex())]",
            "apiVersion": "2017-12-01",
            "location": "[variables('location')]",
            "tags": {},
            "scale": null,
            "properties": {
                "hardwareProfile": {
                    "vmSize": "Standard_DS3_v2_Promo"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "RedHat",
                        "offer": "RHEL",
                        "sku": "7.3",
                        "version": "7.3.2017090723"
                    },
                    "osDisk": {
                        "osType": "Linux",
                        "name": "[concat('d', copyIndex(),'_osDisk_1_', variables('uniqueString1'))]",
                        "createOption": "FromImage",
                        "caching": "ReadWrite",
                        "managedDisk": {
                            "id": "[concat('d', copyIndex(),'_osDisk_1_', variables('uniqueString1'))]"
                        }
                    },
                    "dataDisks": [
                        {
                            "lun": 0,
                            "name": "[concat('d', copyIndex(),'_dataDisk_lun0')]",
                            "createOption": "Empty",
                            "diskSizeGB": 32,
                            "caching": "None",
                            "managedDisk": {
                                "id": "[concat('d', copyIndex(),'_dataDisk_lun0_', variables('uniqueString1'))]",
                                "storageAccountType": "Premium_LRS"
                            }
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[concat('d', copyIndex())]",
                    "adminUsername": "rhel",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": true,
                        "ssh": {
                            "publicKeys": [
                                {
                                    "path": "/home/rhel/.ssh/authorized_keys",
                                    "keyData": "[concat(parameters('pubKeyValue'), '\n')]"
                                }
                            ]
                        }
                    },
                    "secrets": []
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat('d', copyIndex(), '_main'))]",
                            "properties": {
                                "primary": true
                            }
                        },
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat('d', copyIndex(), '_gfsfe'))]",
                            "properties": {
                                "primary": false
                            }
                        },
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat('d', copyIndex(), '_db2be'))]",
                            "properties": {
                                "primary": false
                            }
                        },
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat('d', copyIndex(), '_db2fe'))]",
                            "properties": {
                                "primary": false
                            }
                        }
                    ]
                }
            },
            "copy": {
                "name": "db2_member_vms_copy",
                "count": "[parameters('nbDb2MemberVms')]"
            },
            "dependsOn": ["db2_member_nics_copy"]
        },
        {
            "comments": "db2 CF NICs",
            "type": "Microsoft.Resources/deployments",
            "name": "db2_cf_nics",
            "apiVersion": "2015-01-01",
            "properties": {
                    "mode": "Incremental",
                    "templateLink": {
                    "uri": "[concat(variables('linkedTemplatesUrl'), 'nics_template.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    },
                    "subnetName": {
                        "value": "[variables('db2CfSubnets')[copyIndex()]]"
                    },
                    "ipAdddressPrefix": {
                        "value": "[variables('db2CfIpAdddressPrefixes')[copyIndex()]]"
                    },
                    "vmPrefix": {
                        "value": "d"
                    },
                    "nb_vms": {
                        "value": "[parameters('nbDb2MemberVms')]"
                    }
                }
            },
            "copy": {
                "name": "db2_member_nics_copy",
                "count": "[length(variables('db2MemberSubnets'))]"
            },
            "dependsOn": ["vNetAndNsg"]            
        },
        {
            "comments": "db2 members VMs",
            "type": "Microsoft.Compute/virtualMachines",
            "name": "[concat('d', copyIndex())]",
            "apiVersion": "2017-12-01",
            "location": "[variables('location')]",
            "tags": {},
            "scale": null,
            "properties": {
                "hardwareProfile": {
                    "vmSize": "Standard_DS3_v2_Promo"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "RedHat",
                        "offer": "RHEL",
                        "sku": "7.3",
                        "version": "7.3.2017090723"
                    },
                    "osDisk": {
                        "osType": "Linux",
                        "name": "[concat('d', copyIndex(),'_osDisk_1_', variables('uniqueString1'))]",
                        "createOption": "FromImage",
                        "caching": "ReadWrite",
                        "managedDisk": {
                            "id": "[concat('d', copyIndex(),'_osDisk_1_', variables('uniqueString1'))]"
                        }
                    },
                    "dataDisks": [
                        {
                            "lun": 0,
                            "name": "[concat('d', copyIndex(),'_dataDisk_lun0')]",
                            "createOption": "Empty",
                            "diskSizeGB": 32,
                            "caching": "None",
                            "managedDisk": {
                                "id": "[concat('d', copyIndex(),'_dataDisk_lun0_', variables('uniqueString1'))]",
                                "storageAccountType": "Premium_LRS"
                            }
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[concat('d', copyIndex())]",
                    "adminUsername": "rhel",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": true,
                        "ssh": {
                            "publicKeys": [
                                {
                                    "path": "/home/rhel/.ssh/authorized_keys",
                                    "keyData": "[concat(parameters('pubKeyValue'), '\n')]"
                                }
                            ]
                        }
                    },
                    "secrets": []
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat('d', copyIndex(), '_main'))]",
                            "properties": {
                                "primary": true
                            }
                        },
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat('d', copyIndex(), '_gfsfe'))]",
                            "properties": {
                                "primary": false
                            }
                        },
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat('d', copyIndex(), '_db2be'))]",
                            "properties": {
                                "primary": false
                            }
                        },
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat('d', copyIndex(), '_db2fe'))]",
                            "properties": {
                                "primary": false
                            }
                        }
                    ]
                }
            },
            "copy": {
                "name": "db2_member_vms_copy",
                "count": "[parameters('nbDb2MemberVms')]"
            },
            "dependsOn": ["db2_member_nics_copy"]
        },
        {
            "comments": "XXX glusterfs member NICs",
            "type": "Microsoft.Resources/deployments",
            "name": "db2_member_nics",
            "apiVersion": "2015-01-01",
            "properties": {
                    "mode": "Incremental",
                    "templateLink": {
                    "uri": "[concat(variables('linkedTemplatesUrl'), 'nics_template.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    },
                    "subnetName": {
                        "value": "[variables('db2MemberSubnets')[copyIndex()]]"
                    },
                    "ipAdddressPrefix": {
                        "value": "[variables('db2MemberIpAdddressPrefixes')[copyIndex()]]"
                    },
                    "vmPrefix": {
                        "value": "d"
                    },
                    "nb_vms": {
                        "value": "[parameters('nbDb2MemberVms')]"
                    }
                }
            },
            "copy": {
                "name": "db2_member_nics_copy",
                "count": "[length(variables('db2MemberSubnets'))]"
            },
            "dependsOn": ["vNetAndNsg"]            
        },
        {
            "comments": "db2 members VMs",
            "type": "Microsoft.Compute/virtualMachines",
            "name": "[concat('d', copyIndex())]",
            "apiVersion": "2017-12-01",
            "location": "[variables('location')]",
            "tags": {},
            "scale": null,
            "properties": {
                "hardwareProfile": {
                    "vmSize": "Standard_DS3_v2_Promo"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "RedHat",
                        "offer": "RHEL",
                        "sku": "7.3",
                        "version": "7.3.2017090723"
                    },
                    "osDisk": {
                        "osType": "Linux",
                        "name": "[concat('d', copyIndex(),'_osDisk_1_', variables('uniqueString1'))]",
                        "createOption": "FromImage",
                        "caching": "ReadWrite",
                        "managedDisk": {
                            "id": "[concat('d', copyIndex(),'_osDisk_1_', variables('uniqueString1'))]"
                        }
                    },
                    "dataDisks": [
                        {
                            "lun": 0,
                            "name": "[concat('d', copyIndex(),'_dataDisk_lun0')]",
                            "createOption": "Empty",
                            "diskSizeGB": 32,
                            "caching": "None",
                            "managedDisk": {
                                "id": "[concat('d', copyIndex(),'_dataDisk_lun0_', variables('uniqueString1'))]",
                                "storageAccountType": "Premium_LRS"
                            }
                        }
                    ]
                },
                "osProfile": {
                    "computerName": "[concat('d', copyIndex())]",
                    "adminUsername": "rhel",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": true,
                        "ssh": {
                            "publicKeys": [
                                {
                                    "path": "/home/rhel/.ssh/authorized_keys",
                                    "keyData": "[concat(parameters('pubKeyValue'), '\n')]"
                                }
                            ]
                        }
                    },
                    "secrets": []
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat('d', copyIndex(), '_main'))]",
                            "properties": {
                                "primary": true
                            }
                        },
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat('d', copyIndex(), '_gfsfe'))]",
                            "properties": {
                                "primary": false
                            }
                        },
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat('d', copyIndex(), '_db2be'))]",
                            "properties": {
                                "primary": false
                            }
                        },
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', concat('d', copyIndex(), '_db2fe'))]",
                            "properties": {
                                "primary": false
                            }
                        }
                    ]
                }
            },
            "copy": {
                "name": "db2_member_vms_copy",
                "count": "[parameters('nbDb2MemberVms')]"
            },
            "dependsOn": ["db2_member_nics_copy"]
        },
        {
            "comments": "witness NICs",
            "type": "Microsoft.Resources/deployments",
            "name": "witness_nics",
            "apiVersion": "2015-01-01",
            "properties": {
                    "mode": "Incremental",
                    "templateLink": {
                    "uri": "[concat(variables('linkedTemplatesUrl'), 'nics_template.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vnetName": {
                        "value": "[parameters('vnetName')]"
                    },
                    "subnetName": {
                        "value": "[variables('witnessSubnets')[copyIndex()]]"
                    },
                    "ipAdddressPrefix": {
                        "value": "[variables('witnessIpAdddressPrefixes')[copyIndex()]]"
                    },
                    "vmPrefix": {
                        "value": "witn"
                    },
                    "nb_vms": {
                        "value": 1
                    }
                }
            },
            "dependsOn": ["vNetAndNsg"]            
        },
        {
            "comments": "Witness VM",
            "type": "Microsoft.Compute/virtualMachines",
            "name": "witn1",
            "apiVersion": "2017-12-01",
            "location": "[variables('location')]",
            "tags": {},
            "scale": null,
            "properties": {
                "hardwareProfile": {
                    "vmSize": "Standard_B1s"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "OpenLogic",
                        "offer": "CentOS",
                        "sku": "7.3",
                        "version": "latest"
                    },
                    "osDisk": {
                        "osType": "Linux",
                        "name": "[concat('witn1_osDisk_1_', variables('uniqueString1'))]",
                        "createOption": "FromImage",
                        "caching": "ReadWrite",
                        "managedDisk": {
                            "id": "[concat('witn1_osDisk_1_', variables('uniqueString1'))]"
                        }
                    },
                    "dataDisks": []
                },
                "osProfile": {
                    "computerName": "witn1",
                    "adminUsername": "rhel",
                    "linuxConfiguration": {
                        "disablePasswordAuthentication": true,
                        "ssh": {
                            "publicKeys": [
                                {
                                    "path": "/home/rhel/.ssh/authorized_keys",
                                    "keyData": "[concat(parameters('pubKeyValue'), '\n')]"
                                }
                            ]
                        }
                    },
                    "secrets": []
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', 'witn0_main')]",
                            "properties": {
                                "primary": true
                            }
                        },
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', 'witn0_gpfsfe')]",
                            "properties": {
                                "primary": false
                            }
                        },
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', 'witn0_db2fe')]",
                            "properties": {
                                "primary": false
                            }
                        },
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', 'witn0_db2be')]",
                            "properties": {
                                "primary": false
                            }
                        }
                    ]
                }
            },
            "dependsOn": [
                "witness_nics"
            ]
        },







        {
            "comments": "Generalized from resource: '/subscriptions/b4ed3d75-dd0d-4660-aacd-7cb2d1bed125/resourceGroups/a_180503a/providers/Microsoft.Network/networkInterfaces/jumpbox'.",
            "type": "Microsoft.Network/networkInterfaces",
            "name": "[parameters('networkInterfaces_jumpbox_name')]",
            "apiVersion": "2018-02-01",
            "location": "[variables('location')]",
            "scale": null,
            "properties": {
                "provisioningState": "Succeeded",
                "resourceGuid": "35d544db-63ff-46f6-b9a3-bc6d3d272d24",
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "etag": "W/\"c66665d5-0c95-4139-9829-df92e18df308\"",
                        "properties": {
                            "provisioningState": "Succeeded",
                            "privateIPAddress": "192.168.1.5",
                            "privateIPAllocationMethod": "Static",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIPAddresses_jumpbox_pubip_name'))]"
                            },
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_gluster_name'), parameters('subnets_client_name'))]"
                            },
                            "primary": true,
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "dnsSettings": {
                    "dnsServers": [],
                    "appliedDnsServers": [],
                    "internalDomainNameSuffix": "iwqjlgo12l1ufkh32gwtnj3hle.ax.internal.cloudapp.net"
                },
                "enableAcceleratedNetworking": false,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_gluster_nsg_name'))]"
                }
            },
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', parameters('publicIPAddresses_jumpbox_pubip_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworks_gluster_name'), parameters('subnets_client_name'))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroups_gluster_nsg_name'))]"
            ]
        }
    ]
}